<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Nosto Autocomplete</title>
        <link rel="stylesheet" href="global.css" />

        <!-- Include default nosto code -->
        <script>
            ;(function () {
                var name = 'nostojs'
                window[name] =
                    window[name] ||
                    function (cb) {
                        ;(window[name].q = window[name].q || []).push(cb)
                    }
            })()
        </script>

        <!-- Include demo merchant with ability to run it locally -->
        <script
            src="https://connect.nosto.com/include/shopify-9758212174"
            async
            onload="setTimeout(function() { window.nosto.reload({site: location.hostname, searchEnabled: false }) }, 100)"
        ></script>
        <script
            src="../../dist/nosto-autocomplete.umd.js"
            async
            onload="setTimeout(function() { window.initAutocomplete() }, 100)"
        ></script>

        <!-- Include browser bundle of react -->
        <script
            src="https://unpkg.com/react@18/umd/react.production.min.js"
            crossorigin
        ></script>
        <script
            src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
            crossorigin
        ></script>

        <!-- Include browser babel (do not use in production) -->
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

        <link rel="stylesheet" href="autocomplete.css" />
        <script type="text/babel">
            function Autocomplete({ response }) {
                if (
                    !response.keywords ||
                    !response.keywords.hits.length ||
                    !response.products ||
                    !response.products.hits.length
                ) {
                    return null
                }

                return (
                    <div class="ns-autocomplete-results">
                        {response.keywords &&
                            response.keywords.hits.length > 0 && (
                                <div class="ns-autocomplete-keywords">
                                    <div class="ns-autocomplete-header">
                                        Keywords
                                    </div>
                                    {response.keywords.hits.map((hit) => {
                                        return (
                                            <div
                                                class="ns-autocomplete-keyword"
                                                data-ns-hit={JSON.stringify(
                                                    hit,
                                                )}
                                            >
                                                {hit._highlight &&
                                                hit._highlight.keyword ? (
                                                    <span
                                                        dangerouslySetInnerHTML={{
                                                            __html: hit
                                                                ._highlight
                                                                .keyword,
                                                        }}
                                                    ></span>
                                                ) : (
                                                    <span>{hit.keyword}</span>
                                                )}
                                            </div>
                                        )
                                    })}
                                </div>
                            )}
                        {response.products &&
                            response.products.hits.length > 0 && (
                                <div class="ns-autocomplete-products">
                                    <div class="ns-autocomplete-header">
                                        Products
                                    </div>
                                    {response.products.hits.map((hit) => {
                                        return (
                                            <a
                                                class="ns-autocomplete-product"
                                                href={hit.url}
                                                data-ns-hit={JSON.stringify(
                                                    hit,
                                                )}
                                            >
                                                <img
                                                    class="ns-autocomplete-product-image"
                                                    src={hit.imageUrl}
                                                    alt={hit.name}
                                                    width="60"
                                                    height="40"
                                                />
                                                <div class="ns-autocomplete-product-info">
                                                    {hit.brand && (
                                                        <div class="ns-autocomplete-product-brand">
                                                            {hit.brand}
                                                        </div>
                                                    )}
                                                    <div class="ns-autocomplete-product-name">
                                                        {hit.name}
                                                    </div>
                                                    <div>
                                                        <span>
                                                            {hit.price}&euro;
                                                        </span>
                                                        {hit.listPrice && (
                                                            <span class="ns-autocomplete-product-list-price">
                                                                {hit.listPrice}
                                                                &euro;
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </a>
                                        )
                                    })}
                                </div>
                            )}
                        <div class="ns-autocomplete-submit">
                            <button
                                type="submit"
                                class="ns-autocomplete-button"
                            >
                                See all search results
                            </button>
                        </div>
                    </div>
                )
            }

            window.initAutocomplete = function () {
                let reactRoot = undefined

                window.nostoAutocomplete.autocomplete({
                    fetch: {
                        products: {
                            fields: [
                                'name',
                                'url',
                                'imageUrl',
                                'price',
                                'listPrice',
                                'brand',
                            ],
                            size: 5,
                        },
                        keywords: {
                            size: 5,
                            fields: ['keyword', '_highlight.keyword'],
                            highlight: {
                                preTag: `<strong>`,
                                postTag: '</strong>',
                            },
                        },
                    },
                    inputSelector: '#search',
                    dropdownSelector: '#search-results',
                    render: function (container, state) {
                        if (!reactRoot) {
                            reactRoot = ReactDOM.createRoot(container)
                        }
                        reactRoot.render(<Autocomplete {...state} />)
                    },
                })
            }
        </script>
    </head>

    <body>
        <form id="search-form">
            <input type="text" id="search" placeholder="search" />
            <button type="submit" id="search-button">Search</button>
            <div id="search-results" class="ns-autocomplete"></div>
        </form>
    </body>
</html>
